import{a as g}from"./chunk-QUOKTBBC.js";import{b as p,e as S}from"./chunk-7IN67ZTX.js";import{Q as h,U as l,i as u,p as a}from"./chunk-ZNSDKUAS.js";var m={production:!0,apiBaseUrl:"https://prateekkarna-001-site1.qtempurl.com",authConfig:{issuer:"https://accounts.google.com",clientId:"15011162966-3i4v2jjdg1enmaltljltfkl0jj8hkk1n.apps.googleusercontent.com",redirectUri:"https://prideofmithila.github.io/prayatna-ui/",tokenEndpoint:"https://prateekkarna-001-site1.qtempurl.com/api/Auth/token",responseType:"code",scope:"profile email",strictDiscoveryDocumentValidation:!1,showDebugInformation:!1,usePkce:!0,skipIssuerCheck:!0,oidc:!1,skipSubjectCheck:!0}};var b="prayatna.sessions.v1",f="prayatna.hiddenSessions.v1",k=class c{constructor(s,e){this.http=s;this.oauth=e}sessionsSubject=new u(this.loadLocal());sessions$=this.sessionsSubject.asObservable();baseUrl=m.apiBaseUrl?.replace(/\/$/,"")||"";isLoggedIn(){try{let s=this.oauth.hasValidAccessToken();return console.log("isLoggedIn check:",s,"Token:",this.oauth.getAccessToken()?.substring(0,20)),s}catch{return!1}}getSnapshot(){return this.sessionsSubject.getValue()}async refreshSessions(){let s=this.loadLocal();if(!this.isLoggedIn()||!this.baseUrl){console.log("Not logged in, fetching public predefined sessions...");try{let t=(await a(this.http.get(`${this.baseUrl}/api/Sessions/public`))||[]).map(o=>this.fromDto(o));console.log("Public sessions received:",t.length);let i=[...t,...s];console.log("Combined sessions (public + local):",i.length),this.sessionsSubject.next(i)}catch(e){console.error("Failed to fetch public sessions, showing only local storage",e),this.sessionsSubject.next(s)}return}try{console.log("Logged in, fetching from API...");let t=(await a(this.http.get(`${this.baseUrl}/api/sessions`,{headers:this.authHeaders()}))||[]).map(r=>this.fromDto(r));console.log("API sessions received:",t.length);let i=s.filter(r=>!r.id),o=[...t,...i];console.log("Combined sessions:",o.length),this.sessionsSubject.next(o),this.saveLocal(i)}catch(e){console.error("Failed to load sessions from API, falling back to local storage",e),this.sessionsSubject.next(s)}}async saveSession(s,e,t){if(this.isLoggedIn()&&this.baseUrl){let r=this.toDto(s);try{if(r.id)await a(this.http.put(`${this.baseUrl}/api/sessions/${r.id}`,r,{headers:this.authHeaders()}));else{let n=await a(this.http.post(`${this.baseUrl}/api/sessions`,r,{headers:this.authHeaders()}));s.id=n.id}return s}catch(n){throw console.error("API save failed",n),n}}let i=this.loadLocal(),o=-1;if(typeof e=="number"&&e>=0&&e<i.length&&(o=e),o<0&&t){let r=JSON.stringify(t);o=i.findIndex(n=>JSON.stringify(n)===r)}return o>=0?i[o]=s:i.push(s),this.saveLocal(i),this.sessionsSubject.next(i),s}async deleteSession(s){let e=this.getSnapshot(),t=e[s];if(!t)return;if(!this.isLoggedIn()){if(t.id)throw new Error("This session is synced or system-generated. Please sign in to manage it.");let o=this.loadLocal(),r=o.findIndex(n=>JSON.stringify(n)===JSON.stringify(t));if(r>=0){o.splice(r,1),this.saveLocal(o);let n=e.filter((d,v)=>v!==s);this.sessionsSubject.next(n)}return}if(t.isPredefined&&t.id)if(this.isLoggedIn()&&this.baseUrl)try{await a(this.http.post(`${this.baseUrl}/api/Sessions/${t.id}/toggle-visibility`,{},{headers:this.authHeaders()}));let o=e.filter((r,n)=>n!==s);this.sessionsSubject.next(o);return}catch(o){console.error("API toggle-visibility failed; storing preference locally",o),this.hideSession(t.id);let r=e.filter((n,d)=>d!==s);this.sessionsSubject.next(r);return}else throw new Error("Please sign in to hide system-generated sessions from your profile. System-generated sessions cannot be deleted by guest users.");if(this.isLoggedIn()&&this.baseUrl&&t.id)try{await a(this.http.delete(`${this.baseUrl}/api/sessions/${t.id}`,{headers:this.authHeaders()}));let o=e.filter((r,n)=>n!==s);this.sessionsSubject.next(o);return}catch(o){throw console.error("API delete failed; not deleting locally",o),o}let i=this.loadLocal();s>=0&&s<i.length&&(i.splice(s,1),this.saveLocal(i),this.sessionsSubject.next(i))}clearApiSessions(){let s=this.loadLocal().filter(e=>!e.id);this.saveLocal(s),this.sessionsSubject.next(s)}getHiddenSessionIds(){try{let s=localStorage.getItem(f);return s?JSON.parse(s):[]}catch{return[]}}saveHiddenSessionIds(s){try{localStorage.setItem(f,JSON.stringify(s))}catch(e){console.error("Failed to save hidden sessions",e)}}hideSession(s){let e=this.getHiddenSessionIds();e.includes(s)||(e.push(s),this.saveHiddenSessionIds(e))}exportJson(s){return JSON.stringify(s,null,2)}importJson(s){return JSON.parse(s)}authHeaders(){let s=this.oauth.getAccessToken(),e={"Content-Type":"application/json"};return s&&(e.Authorization=`Bearer ${s}`),new p(e)}toDto(s){return{id:s.id,title:s.sessionName,description:s.description,durationSeconds:s.totalDuration||0,isPredefined:!1,tasks:(s.tasks||[]).map((e,t)=>({id:e.id,title:e.taskName,durationSeconds:e.taskDuration||0,order:t+1,subtasks:(e.subtasks||[]).map((i,o)=>({id:i.id,title:i.subtaskName,durationSeconds:i.duration||0,order:i.order||o+1}))}))}}fromDto(s){let e=(s.tasks||[]).map(t=>({id:t.id,taskName:t.title,hasSubtasks:!!(t.subtasks&&t.subtasks.length),taskDuration:t.durationSeconds||0,order:t.order,subtasks:(t.subtasks||[]).map(i=>({id:i.id,subtaskName:i.title,duration:i.durationSeconds||0,order:i.order}))}));return{id:s.id,sessionName:s.title,description:s.description,isTimed:!0,totalDuration:(s.totalDuration??s.durationSeconds)||this.computeTotal(e),tasks:e,isPredefined:s.isPredefined||!1}}computeTotal(s){return s.reduce((e,t)=>t.hasSubtasks&&t.subtasks?.length?e+t.subtasks.reduce((i,o)=>i+(o.duration||0),0):e+(t.taskDuration||0),0)}loadLocal(){try{let s=localStorage.getItem(b);return s?JSON.parse(s):[]}catch(s){return console.error("Failed to parse sessions from storage",s),[]}}saveLocal(s){localStorage.setItem(b,JSON.stringify(s))}static \u0275fac=function(e){return new(e||c)(l(S),l(g))};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};export{m as a,k as b};
