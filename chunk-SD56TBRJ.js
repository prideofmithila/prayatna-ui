import{a as h}from"./chunk-JECU2FWR.js";import{b as d,e as p}from"./chunk-6RMNFVTM.js";import{Q as u,U as c,i as l,p as r}from"./chunk-IBNF2MKV.js";var m={production:!0,apiBaseUrl:"https://prateekkarna-001-site1.qtempurl.com",authConfig:{issuer:"https://accounts.google.com",clientId:"15011162966-3i4v2jjdg1enmaltljltfkl0jj8hkk1n.apps.googleusercontent.com",redirectUri:"https://prideofmithila.github.io/prayatna-ui/",tokenEndpoint:"https://prateekkarna-001-site1.qtempurl.com/api/Auth/token",responseType:"code",scope:"profile email",strictDiscoveryDocumentValidation:!1,showDebugInformation:!1,usePkce:!0,skipIssuerCheck:!0,oidc:!1,skipSubjectCheck:!0}};var S="prayatna.sessions.v1",b=class n{constructor(s,e){this.http=s;this.oauth=e}sessionsSubject=new l(this.loadLocal());sessions$=this.sessionsSubject.asObservable();baseUrl=m.apiBaseUrl?.replace(/\/$/,"")||"";isLoggedIn(){try{let s=this.oauth.hasValidAccessToken();return console.log("isLoggedIn check:",s,"Token:",this.oauth.getAccessToken()?.substring(0,20)),s}catch{return!1}}getSnapshot(){return this.sessionsSubject.getValue()}async refreshSessions(){let s=this.loadLocal();if(!this.isLoggedIn()||!this.baseUrl){console.log("Not logged in, showing local sessions:",s.length),this.sessionsSubject.next(s);return}try{console.log("Logged in, fetching from API...");let t=(await r(this.http.get(`${this.baseUrl}/api/sessions`,{headers:this.authHeaders()}))||[]).map(a=>this.fromDto(a));console.log("API sessions received:",t.length);let i=s.filter(a=>!a.id),o=[...t,...i];console.log("Combined sessions:",o.length),this.sessionsSubject.next(o),this.saveLocal(i)}catch(e){console.error("Failed to load sessions from API, falling back to local storage",e),this.sessionsSubject.next(s)}}async saveSession(s,e){if(this.isLoggedIn()&&this.baseUrl){let i=this.toDto(s);try{if(i.id)await r(this.http.put(`${this.baseUrl}/api/sessions/${i.id}`,i,{headers:this.authHeaders()}));else{let o=await r(this.http.post(`${this.baseUrl}/api/sessions`,i,{headers:this.authHeaders()}));s.id=o.id}return s}catch(o){throw console.error("API save failed",o),o}}let t=this.loadLocal();return typeof e=="number"&&e>=0&&e<t.length?t[e]=s:t.push(s),this.saveLocal(t),this.sessionsSubject.next(t),s}async deleteSession(s){let e=this.getSnapshot(),t=e[s];if(!t)return;if(this.isLoggedIn()&&this.baseUrl&&t.id)try{await r(this.http.delete(`${this.baseUrl}/api/sessions/${t.id}`,{headers:this.authHeaders()}));let o=e.filter((a,g)=>g!==s);this.sessionsSubject.next(o);return}catch(o){throw console.error("API delete failed; not deleting locally",o),o}let i=this.loadLocal();s>=0&&s<i.length&&(i.splice(s,1),this.saveLocal(i),this.sessionsSubject.next(i))}clearApiSessions(){let s=this.loadLocal().filter(e=>!e.id);this.saveLocal(s),this.sessionsSubject.next(s)}exportJson(s){return JSON.stringify(s,null,2)}importJson(s){return JSON.parse(s)}authHeaders(){let s=this.oauth.getAccessToken(),e={"Content-Type":"application/json"};return s&&(e.Authorization=`Bearer ${s}`),new d(e)}toDto(s){return{id:s.id,title:s.sessionName,description:s.description,durationSeconds:s.totalDuration||0,isPredefined:!1,tasks:(s.tasks||[]).map((e,t)=>({id:e.id,title:e.taskName,durationSeconds:e.taskDuration||0,order:t+1,subtasks:(e.subtasks||[]).map((i,o)=>({id:i.id,title:i.subtaskName,durationSeconds:i.duration||0,order:i.order||o+1}))}))}}fromDto(s){let e=(s.tasks||[]).map(t=>({id:t.id,taskName:t.title,hasSubtasks:!!(t.subtasks&&t.subtasks.length),taskDuration:t.durationSeconds||0,order:t.order,subtasks:(t.subtasks||[]).map(i=>({id:i.id,subtaskName:i.title,duration:i.durationSeconds||0,order:i.order}))}));return{id:s.id,sessionName:s.title,description:s.description,isTimed:!0,totalDuration:(s.totalDuration??s.durationSeconds)||this.computeTotal(e),tasks:e}}computeTotal(s){return s.reduce((e,t)=>t.hasSubtasks&&t.subtasks?.length?e+t.subtasks.reduce((i,o)=>i+(o.duration||0),0):e+(t.taskDuration||0),0)}loadLocal(){try{let s=localStorage.getItem(S);return s?JSON.parse(s):[]}catch(s){return console.error("Failed to parse sessions from storage",s),[]}}saveLocal(s){localStorage.setItem(S,JSON.stringify(s))}static \u0275fac=function(e){return new(e||n)(c(p),c(h))};static \u0275prov=u({token:n,factory:n.\u0275fac,providedIn:"root"})};export{m as a,b};
