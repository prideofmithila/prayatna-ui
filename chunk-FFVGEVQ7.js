import{a as m}from"./chunk-QUOKTBBC.js";import{b as S,e as f}from"./chunk-7IN67ZTX.js";import{Q as p,U as u,i as h,p as a}from"./chunk-ZNSDKUAS.js";var b={production:!0,apiBaseUrl:"https://prateekkarna-001-site1.qtempurl.com",authConfig:{issuer:"https://accounts.google.com",clientId:"15011162966-3i4v2jjdg1enmaltljltfkl0jj8hkk1n.apps.googleusercontent.com",redirectUri:"https://prideofmithila.github.io/prayatna-ui/",tokenEndpoint:"https://prateekkarna-001-site1.qtempurl.com/api/Auth/token",responseType:"code",scope:"profile email",strictDiscoveryDocumentValidation:!1,showDebugInformation:!1,usePkce:!0,skipIssuerCheck:!0,oidc:!1,skipSubjectCheck:!0}};var g="prayatna.sessions.v1",k="prayatna.hiddenSessions.v1",v=class d{constructor(s,e){this.http=s;this.oauth=e}sessionsSubject=new h(this.loadLocal());sessions$=this.sessionsSubject.asObservable();baseUrl=b.apiBaseUrl?.replace(/\/$/,"")||"";isLoggedIn(){try{return this.oauth.hasValidAccessToken()}catch{return!1}}getSnapshot(){return this.sessionsSubject.getValue()}async refreshSessions(){let s=this.loadLocal();if(!this.isLoggedIn()||!this.baseUrl){try{let o=[...(await a(this.http.get(`${this.baseUrl}/api/Sessions/public`))||[]).map(i=>this.fromDto(i)),...s];this.sessionsSubject.next(o)}catch(e){console.error("Failed to fetch public sessions, showing only local storage",e),this.sessionsSubject.next(s)}return}try{let t=(await a(this.http.get(`${this.baseUrl}/api/sessions`,{headers:this.authHeaders()}))||[]).map(r=>this.fromDto(r)),o=s.filter(r=>!r.id),i=[...t,...o];this.sessionsSubject.next(i),this.saveLocal(o)}catch(e){console.error("Failed to load sessions from API, falling back to local storage",e),this.sessionsSubject.next(s)}}async saveSession(s,e,t){if(this.isLoggedIn()&&this.baseUrl){let r=this.toDto(s);try{if(r.id)await a(this.http.put(`${this.baseUrl}/api/sessions/${r.id}`,r,{headers:this.authHeaders()}));else{let n=await a(this.http.post(`${this.baseUrl}/api/sessions`,r,{headers:this.authHeaders()}));s.id=n.id}return s}catch(n){throw console.error("API save failed",n),n}}let o=this.loadLocal(),i=-1;if(typeof e=="number"&&e>=0&&e<o.length&&(i=e),i<0&&t){let r=JSON.stringify(t);i=o.findIndex(n=>JSON.stringify(n)===r)}return i>=0?o[i]=s:o.push(s),this.saveLocal(o),this.sessionsSubject.next(o),s}async deleteSession(s){let e=this.getSnapshot(),t=e[s];if(!t)return;if(!this.isLoggedIn()){if(t.id)throw new Error("This session is synced or system-generated. Please sign in to manage it.");let i=this.loadLocal(),r=i.findIndex(n=>JSON.stringify(n)===JSON.stringify(t));if(r>=0){i.splice(r,1),this.saveLocal(i);let n=e.filter((c,l)=>l!==s);this.sessionsSubject.next(n)}return}if(t.isPredefined&&t.id)if(this.isLoggedIn()&&this.baseUrl)try{await a(this.http.post(`${this.baseUrl}/api/Sessions/${t.id}/toggle-visibility`,{},{headers:this.authHeaders()}));let i=e.filter((r,n)=>n!==s);this.sessionsSubject.next(i);return}catch(i){console.error("API toggle-visibility failed; storing preference locally",i),this.hideSession(t.id);let r=e.filter((n,c)=>c!==s);this.sessionsSubject.next(r);return}else throw new Error("Please sign in to hide system-generated sessions from your profile. System-generated sessions cannot be deleted by guest users.");if(this.isLoggedIn()&&this.baseUrl&&t.id)try{await a(this.http.delete(`${this.baseUrl}/api/sessions/${t.id}`,{headers:this.authHeaders()}));let i=e.filter((r,n)=>n!==s);this.sessionsSubject.next(i);return}catch(i){throw console.error("API delete failed; not deleting locally",i),i}if(this.isLoggedIn()&&!t.id){let i=this.loadLocal(),r=i.findIndex(c=>JSON.stringify(c)===JSON.stringify(t));r>=0&&(i.splice(r,1),this.saveLocal(i));let n=e.filter((c,l)=>l!==s);this.sessionsSubject.next(n);return}let o=this.loadLocal();s>=0&&s<o.length&&(o.splice(s,1),this.saveLocal(o),this.sessionsSubject.next(o))}clearApiSessions(){let s=this.loadLocal().filter(e=>!e.id);this.saveLocal(s),this.sessionsSubject.next(s)}getHiddenSessionIds(){try{let s=localStorage.getItem(k);return s?JSON.parse(s):[]}catch{return[]}}saveHiddenSessionIds(s){try{localStorage.setItem(k,JSON.stringify(s))}catch(e){console.error("Failed to save hidden sessions",e)}}hideSession(s){let e=this.getHiddenSessionIds();e.includes(s)||(e.push(s),this.saveHiddenSessionIds(e))}exportJson(s){return JSON.stringify(s,null,2)}importJson(s){return JSON.parse(s)}authHeaders(){let s=this.oauth.getAccessToken(),e={"Content-Type":"application/json"};return s&&(e.Authorization=`Bearer ${s}`),new S(e)}toDto(s){return{id:s.id,title:s.sessionName,description:s.description,durationSeconds:s.totalDuration||0,isPredefined:!1,tasks:(s.tasks||[]).map((e,t)=>({id:e.id,title:e.taskName,durationSeconds:e.taskDuration||0,order:t+1,subtasks:(e.subtasks||[]).map((o,i)=>({id:o.id,title:o.subtaskName,durationSeconds:o.duration||0,order:o.order||i+1}))}))}}fromDto(s){let e=(s.tasks||[]).map(t=>({id:t.id,taskName:t.title,hasSubtasks:!!(t.subtasks&&t.subtasks.length),taskDuration:t.durationSeconds||0,order:t.order,subtasks:(t.subtasks||[]).map(o=>({id:o.id,subtaskName:o.title,duration:o.durationSeconds||0,order:o.order}))}));return{id:s.id,sessionName:s.title,description:s.description,isTimed:!0,totalDuration:(s.totalDuration??s.durationSeconds)||this.computeTotal(e),tasks:e,isPredefined:s.isPredefined||!1}}computeTotal(s){return s.reduce((e,t)=>t.hasSubtasks&&t.subtasks?.length?e+t.subtasks.reduce((o,i)=>o+(i.duration||0),0):e+(t.taskDuration||0),0)}loadLocal(){try{let s=localStorage.getItem(g);return s?JSON.parse(s):[]}catch(s){return console.error("Failed to parse sessions from storage",s),[]}}saveLocal(s){localStorage.setItem(g,JSON.stringify(s))}static \u0275fac=function(e){return new(e||d)(u(f),u(m))};static \u0275prov=p({token:d,factory:d.\u0275fac,providedIn:"root"})};export{b as a,v as b};
