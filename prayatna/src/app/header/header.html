<nav class="navbar bg-light shadow-sm">
  <div class="container-fluid px-3">
    <div class="d-flex align-items-center w-100">
      <!-- Left: Hamburger (mobile) and Brand (desktop) -->
      <div class="d-flex align-items-center" style="flex:0 0 auto;">
        <!-- Mobile hamburger only -->
        <button class="btn btn-outline-primary me-2 d-md-none" type="button" (click)="toggleOffcanvas($event, 'mobile')" aria-label="Toggle menu">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
            <path fill-rule="evenodd" d="M2.5 12.5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1h-10a.5.5 0 0 1-.5-.5zm0-5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1h-10a.5.5 0 0 1-.5-.5zm0-5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1h-10a.5.5 0 0 1-.5-.5z"/>
          </svg>
        </button>

        <!-- Desktop brand on left -->
        <a class="navbar-brand d-none d-md-inline-flex align-items-center gap-2" routerLink="/">
          <img src="assets/logo.png" alt="logo" class="app-logo" onerror="this.style.display='none'"/>
          <span class="fs-5 fw-semibold">Prayatna</span>
        </a>
      </div>

      <!-- Center: Links (desktop only) -->
      <div class="flex-grow-1 d-none d-md-flex justify-content-center position-relative">
        <ul class="nav header-nav" #centerNav>
          <li class="nav-item" *ngFor="let link of links | slice:0:visibleCount; let i = index" [class.position-relative]="link.label === 'Daily Quiz' || link.label === 'Practice Tool' || link.label === 'Social'">
            <!-- Regular links -->
            <a class="nav-link" *ngIf="link.label !== 'Daily Quiz' && link.label !== 'Practice Tool' && link.label !== 'Social'" [routerLink]="link.route" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">{{ link.label }}</a>

            <!-- Daily Quiz dropdown (coming soon) -->
            <a class="nav-link has-icon" href="#" *ngIf="link.label === 'Daily Quiz'" (click)="toggleQuizDropdown($event)" [class.active]="showQuizDropdown">
              <span class="material-icons nav-icon">quiz</span>
              <span>Daily Quiz</span>
            </a>
            <div class="quiz-menu card" *ngIf="link.label === 'Daily Quiz' && showQuizDropdown" (click)="$event.stopPropagation()">
              <div class="card-body py-2 px-3">
                <div class="small text-muted">Coming soon — hang tight!</div>
              </div>
            </div>

            <!-- Practice Tool dropdown -->
            <a class="nav-link has-icon" href="#" *ngIf="link.label === 'Practice Tool'" (click)="togglePracticeDropdown($event)" [class.active]="showPracticeDropdown">
              <span class="material-icons nav-icon">bolt</span>
              <span>Practice Tools</span>
            </a>
            <div class="quiz-menu card" *ngIf="link.label === 'Practice Tool' && showPracticeDropdown" (click)="$event.stopPropagation()">
              <div class="card-body p-0">
                <div class="menu-list py-1">
                  <button class="dropdown-item w-100 text-start" (click)="goToSessions()">
                    <span class="material-icons me-2" style="font-size:18px;vertical-align:middle;">timer</span>
                    Session Timer
                  </button>
                </div>
              </div>
            </div>

            <!-- Social dropdown -->
            <a class="nav-link has-icon" href="#" *ngIf="link.label === 'Social'" (click)="toggleSocialDropdown($event)" [class.active]="showSocialDropdown">
              <span class="material-icons nav-icon">share</span>
              <span>Social</span>
            </a>
            <div class="quiz-menu card" *ngIf="link.label === 'Social' && showSocialDropdown" (click)="$event.stopPropagation()">
              <div class="card-body py-2 px-3">
                <div class="d-flex gap-3 justify-content-center">
                  <a href="https://www.youtube.com" target="_blank" title="YouTube" aria-label="YouTube" class="social-icon-link">
                    <i class="bi bi-youtube"></i>
                  </a>
                  <a href="https://t.me" target="_blank" title="Telegram" aria-label="Telegram" class="social-icon-link">
                    <i class="bi bi-telegram"></i>
                  </a>
                  <a href="https://wa.me" target="_blank" title="WhatsApp" aria-label="WhatsApp" class="social-icon-link">
                    <i class="bi bi-whatsapp"></i>
                  </a>
                </div>
              </div>
            </div>
          </li>
        </ul>
        <!-- More button shown when there are overflowing links -->
        <button #moreBtn class="btn btn-link nav-more ms-2" [class.d-none]="visibleCount >= links.length" (click)="toggleOffcanvas($event, 'more')">More</button>
      </div>

      <!-- Center (mobile): Brand centered on small screens -->
      <div class="flex-grow-1 text-center d-md-none">
        <a class="navbar-brand d-inline-flex align-items-center gap-2" routerLink="/">
          <img src="assets/logo.png" alt="logo" class="app-logo" onerror="this.style.display='none'"/>
          <span class="fs-5 fw-semibold">Prayatna</span>
        </a>
      </div>

      <!-- Right: Profile / Auth -->
      <div class="d-flex align-items-center" style="flex:0 0 auto;">
        <ng-container *ngIf="isLoggedIn; else signedOut">
          <div class="profile-wrapper d-flex align-items-center gap-2 position-relative">
            <button class="btn btn-link p-0 profile-trigger" (click)="toggleProfileMenu($event)" aria-label="Open profile menu">
              <img *ngIf="userPicture" [src]="userPicture" alt="Profile" style="width: 36px; height: 36px; object-fit: cover;" />
              <span *ngIf="!userPicture" class="d-inline-flex align-items-center justify-content-center" style="width: 36px; height: 36px; border-radius: 50%; background: #e9ecef; color: #495057; font-weight: 600;">
                {{ (userName || 'U').charAt(0) | uppercase }}
              </span>
            </button>

            <div class="profile-menu card" *ngIf="isProfileMenuOpen" (click)="$event.stopPropagation()">
              <div class="card-body p-0">
                <div class="user-summary d-flex align-items-center gap-2 px-3 py-2">
                  <img *ngIf="userPicture" [src]="userPicture" alt="Profile" class="user-avatar" />
                  <div class="min-w-0">
                    <div class="fw-semibold text-truncate">{{ userName || 'User' }}</div>
                    <div class="text-muted small text-truncate" *ngIf="userEmail">{{ userEmail }}</div>
                  </div>
                </div>
                <hr class="my-2"/>
                <div class="menu-list py-1">
                  <button class="dropdown-item w-100 text-start text-danger" (click)="signOut()">
                    <span class="material-icons me-2" style="font-size:18px;vertical-align:middle;">logout</span>
                    Sign out
                  </button>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #signedOut>
          <button class="btn btn-primary btn-sm" (click)="signIn()">Sign in</button>
        </ng-template>
      </div>
    </div>
  </div>
</nav>

<!-- Hidden measurement container for calculating overflow -->
<div style="position:absolute;left:-9999px;top:-9999px;visibility:hidden;display:flex;gap:0.5rem;" #measureContainer>
  <a class="nav-link measure-item" *ngFor="let l of links" #measureItem>{{ l.label }}</a>
</div>

<!-- Offcanvas menu (left) -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasMenuLabel">Prayatna</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" #offcanvasBody>
    <div class="offcanvas-panel">
      <ul class="nav flex-column gap-1">
        <li class="nav-item" *ngFor="let link of offcanvasLinks">
          <a class="nav-link" *ngIf="link.label === 'Home'" [routerLink]="link.route" (click)="closeOffcanvas()">
            <span class="material-icons nav-icon">home</span>
            <span>{{ link.label }}</span>
          </a>
          <a class="nav-link" *ngIf="link.label === 'About'" [routerLink]="link.route" (click)="closeOffcanvas()">
            <span class="material-icons nav-icon">info</span>
            <span>{{ link.label }}</span>
          </a>
          <a class="nav-link" *ngIf="link.label === 'Help'" [routerLink]="link.route" (click)="closeOffcanvas()">
            <span class="material-icons nav-icon">help_outline</span>
            <span>{{ link.label }}</span>
          </a>

          <div *ngIf="link.label === 'Daily Quiz'" class="w-100">
            <button class="btn w-100 nav-link text-start nav-row" (click)="toggleMobileQuiz($event)">
              <span class="nav-icon-col"><span class="material-icons nav-icon">quiz</span></span>
              <span class="nav-text">Daily Quiz</span>
              <span class="nav-caret material-icons">{{ mobileQuizOpen ? 'expand_less' : 'expand_more' }}</span>
            </button>
            <div class="ps-4" *ngIf="mobileQuizOpen">
              <div class="text-muted small py-2 rounded-2 bg-light">Coming soon — hang tight!</div>
            </div>
          </div>

          <div *ngIf="link.label === 'Practice Tool'" class="w-100">
            <button class="btn w-100 nav-link text-start nav-row" (click)="toggleMobilePractice($event)">
              <span class="nav-icon-col"><span class="material-icons nav-icon">bolt</span></span>
              <span class="nav-text">Practice Tools</span>
              <span class="nav-caret material-icons">{{ mobilePracticeOpen ? 'expand_less' : 'expand_more' }}</span>
            </button>
            <div class="ps-4" *ngIf="mobilePracticeOpen">
              <a class="nav-link nested-link" [routerLink]="'/sessions'" (click)="closeOffcanvas()">
                <span class="material-icons" style="font-size:18px;">timer</span>
                <span>Session Timer</span>
              </a>
            </div>
          </div>

          <div *ngIf="link.label === 'Social'" class="w-100">
            <button class="btn w-100 nav-link text-start nav-row" (click)="toggleMobileSocial($event)">
              <span class="nav-icon-col"><span class="material-icons nav-icon">share</span></span>
              <span class="nav-text">Social</span>
              <span class="nav-caret material-icons">{{ mobileSocialOpen ? 'expand_less' : 'expand_more' }}</span>
            </button>
            <div class="ps-4" *ngIf="mobileSocialOpen">
              <div class="d-flex gap-3 py-2 rounded-2 bg-light px-3">
                <a href="https://www.youtube.com" target="_blank" title="YouTube" aria-label="YouTube" class="social-icon-link">
                  <i class="bi bi-youtube"></i>
                </a>
                <a href="https://t.me" target="_blank" title="Telegram" aria-label="Telegram" class="social-icon-link">
                  <i class="bi bi-telegram"></i>
                </a>
                <a href="https://wa.me" target="_blank" title="WhatsApp" aria-label="WhatsApp" class="social-icon-link">
                  <i class="bi bi-whatsapp"></i>
                </a>
              </div>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</div>
