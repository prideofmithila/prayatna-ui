import{a as f}from"./chunk-QUOKTBBC.js";import{b as g,e as S}from"./chunk-7IN67ZTX.js";import{Q as p,U as h,i as u,p as l}from"./chunk-ZNSDKUAS.js";var m={production:!0,apiBaseUrl:"https://prateekkarna-001-site1.qtempurl.com",authConfig:{issuer:"https://accounts.google.com",clientId:"15011162966-3i4v2jjdg1enmaltljltfkl0jj8hkk1n.apps.googleusercontent.com",redirectUri:"https://prideofmithila.github.io/prayatna-ui/",tokenEndpoint:"https://prateekkarna-001-site1.qtempurl.com/api/Auth/token",responseType:"code",scope:"profile email",strictDiscoveryDocumentValidation:!1,showDebugInformation:!1,usePkce:!0,skipIssuerCheck:!0,oidc:!1,skipSubjectCheck:!0}};var b="prayatna.sessions.v1",k="prayatna.hiddenSessions.v1",v=class c{constructor(e,s){this.http=e;this.oauth=s}sessionsSubject=new u(this.loadLocal());sessions$=this.sessionsSubject.asObservable();baseUrl=m.apiBaseUrl?.replace(/\/$/,"")||"";isLoggedIn(){try{let e=this.oauth.hasValidAccessToken();return console.log("isLoggedIn check:",e,"Token:",this.oauth.getAccessToken()?.substring(0,20)),e}catch{return!1}}getSnapshot(){return this.sessionsSubject.getValue()}async refreshSessions(){console.log("\u{1F504} refreshSessions called, isLoggedIn:",this.isLoggedIn());let e=this.loadLocal();if(console.log("\u{1F4E6} Loaded from localStorage:",e.length,e.map(s=>s.sessionName+(s.id?` (id:${s.id})`:" (no-id)"))),!this.isLoggedIn()||!this.baseUrl){console.log("Not logged in, fetching public predefined sessions...");try{let t=(await l(this.http.get(`${this.baseUrl}/api/Sessions/public`))||[]).map(o=>this.fromDto(o));console.log("Public sessions received:",t.length);let i=[...t,...e];console.log("Combined sessions (public + local):",i.length),this.sessionsSubject.next(i)}catch(s){console.error("Failed to fetch public sessions, showing only local storage",s),this.sessionsSubject.next(e)}return}try{console.log("Logged in, fetching from API...");let t=(await l(this.http.get(`${this.baseUrl}/api/sessions`,{headers:this.authHeaders()}))||[]).map(n=>this.fromDto(n));console.log("API sessions received:",t.length);let i=e.filter(n=>!n.id);console.log("\u{1F4E6} Local-only sessions (no IDs):",i.length,i.map(n=>n.sessionName));let o=[...t,...i];console.log("Combined sessions:",o.length),this.sessionsSubject.next(o),this.saveLocal(i),console.log("\u{1F4BE} Saved local-only sessions back to localStorage")}catch(s){console.error("Failed to load sessions from API, falling back to local storage",s),this.sessionsSubject.next(e)}}async saveSession(e,s,t){if(this.isLoggedIn()&&this.baseUrl){let n=this.toDto(e);try{if(n.id)await l(this.http.put(`${this.baseUrl}/api/sessions/${n.id}`,n,{headers:this.authHeaders()}));else{let r=await l(this.http.post(`${this.baseUrl}/api/sessions`,n,{headers:this.authHeaders()}));e.id=r.id}return e}catch(r){throw console.error("API save failed",r),r}}let i=this.loadLocal(),o=-1;if(typeof s=="number"&&s>=0&&s<i.length&&(o=s),o<0&&t){let n=JSON.stringify(t);o=i.findIndex(r=>JSON.stringify(r)===n)}return o>=0?i[o]=e:i.push(e),this.saveLocal(i),this.sessionsSubject.next(i),e}async deleteSession(e){let s=this.getSnapshot(),t=s[e];if(console.log("\u{1F5D1}\uFE0F deleteSession called - index:",e,"target:",t?.sessionName,"hasId:",!!t?.id,"isPredefined:",t?.isPredefined,"isLoggedIn:",this.isLoggedIn()),!t){console.log("\u274C No target found at index",e);return}if(!this.isLoggedIn()){if(console.log("\u{1F464} Guest user deletion path"),t.id)throw new Error("This session is synced or system-generated. Please sign in to manage it.");let o=this.loadLocal();console.log("\u{1F4E6} Local sessions before delete:",o.length);let n=o.findIndex(r=>JSON.stringify(r)===JSON.stringify(t));if(console.log("\u{1F50D} Match index in localStorage:",n),n>=0){o.splice(n,1),this.saveLocal(o),console.log("\u2705 Deleted from localStorage, remaining:",o.length);let r=s.filter((a,d)=>d!==e);this.sessionsSubject.next(r)}return}if(t.isPredefined&&t.id)if(console.log("\u{1F512} Predefined session deletion path"),this.isLoggedIn()&&this.baseUrl)try{await l(this.http.post(`${this.baseUrl}/api/Sessions/${t.id}/toggle-visibility`,{},{headers:this.authHeaders()}));let o=s.filter((n,r)=>r!==e);this.sessionsSubject.next(o),console.log("\u2705 Predefined session hidden via API");return}catch(o){console.error("API toggle-visibility failed; storing preference locally",o),this.hideSession(t.id);let n=s.filter((r,a)=>a!==e);this.sessionsSubject.next(n);return}else throw new Error("Please sign in to hide system-generated sessions from your profile. System-generated sessions cannot be deleted by guest users.");if(this.isLoggedIn()&&this.baseUrl&&t.id){console.log("\u{1F310} API session deletion path");try{await l(this.http.delete(`${this.baseUrl}/api/sessions/${t.id}`,{headers:this.authHeaders()}));let o=s.filter((n,r)=>r!==e);this.sessionsSubject.next(o),console.log("\u2705 Deleted from API");return}catch(o){throw console.error("API delete failed; not deleting locally",o),o}}if(this.isLoggedIn()&&!t.id){console.log("\u{1F4BE} Local-only session deletion for logged-in user");let o=this.loadLocal();console.log("\u{1F4E6} Local sessions before delete:",o.length,o.map(a=>a.sessionName));let n=o.findIndex(a=>JSON.stringify(a)===JSON.stringify(t));console.log("\u{1F50D} Match index in localStorage:",n),n>=0?(o.splice(n,1),this.saveLocal(o),console.log("\u2705 Deleted from localStorage, remaining:",o.length,o.map(a=>a.sessionName))):console.log("\u26A0\uFE0F Session not found in localStorage");let r=s.filter((a,d)=>d!==e);console.log("\u{1F4CA} Updated snapshot:",r.length,r.map(a=>a.sessionName)),this.sessionsSubject.next(r);return}console.log("\u26A0\uFE0F Fallback deletion path");let i=this.loadLocal();e>=0&&e<i.length&&(i.splice(e,1),this.saveLocal(i),this.sessionsSubject.next(i),console.log("\u2705 Deleted via fallback path"))}clearApiSessions(){let e=this.loadLocal().filter(s=>!s.id);this.saveLocal(e),this.sessionsSubject.next(e)}getHiddenSessionIds(){try{let e=localStorage.getItem(k);return e?JSON.parse(e):[]}catch{return[]}}saveHiddenSessionIds(e){try{localStorage.setItem(k,JSON.stringify(e))}catch(s){console.error("Failed to save hidden sessions",s)}}hideSession(e){let s=this.getHiddenSessionIds();s.includes(e)||(s.push(e),this.saveHiddenSessionIds(s))}exportJson(e){return JSON.stringify(e,null,2)}importJson(e){return JSON.parse(e)}authHeaders(){let e=this.oauth.getAccessToken(),s={"Content-Type":"application/json"};return e&&(s.Authorization=`Bearer ${e}`),new g(s)}toDto(e){return{id:e.id,title:e.sessionName,description:e.description,durationSeconds:e.totalDuration||0,isPredefined:!1,tasks:(e.tasks||[]).map((s,t)=>({id:s.id,title:s.taskName,durationSeconds:s.taskDuration||0,order:t+1,subtasks:(s.subtasks||[]).map((i,o)=>({id:i.id,title:i.subtaskName,durationSeconds:i.duration||0,order:i.order||o+1}))}))}}fromDto(e){let s=(e.tasks||[]).map(t=>({id:t.id,taskName:t.title,hasSubtasks:!!(t.subtasks&&t.subtasks.length),taskDuration:t.durationSeconds||0,order:t.order,subtasks:(t.subtasks||[]).map(i=>({id:i.id,subtaskName:i.title,duration:i.durationSeconds||0,order:i.order}))}));return{id:e.id,sessionName:e.title,description:e.description,isTimed:!0,totalDuration:(e.totalDuration??e.durationSeconds)||this.computeTotal(s),tasks:s,isPredefined:e.isPredefined||!1}}computeTotal(e){return e.reduce((s,t)=>t.hasSubtasks&&t.subtasks?.length?s+t.subtasks.reduce((i,o)=>i+(o.duration||0),0):s+(t.taskDuration||0),0)}loadLocal(){try{let e=localStorage.getItem(b);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to parse sessions from storage",e),[]}}saveLocal(e){localStorage.setItem(b,JSON.stringify(e))}static \u0275fac=function(s){return new(s||c)(h(S),h(f))};static \u0275prov=p({token:c,factory:c.\u0275fac,providedIn:"root"})};export{m as a,v as b};
